-- CHẠY TRONG MYSQL WORKBENCH
-- Tạo cơ sở dữ liệu QLCHUNGCHI và các bảng trong đó

DROP DATABASE IF EXISTS QLCHUNGCHI;
CREATE DATABASE QLCHUNGCHI;
USE QLCHUNGCHI;

-- ===== Bảng không phụ thuộc =====
DROP TABLE IF EXISTS TAIKHOAN;
CREATE TABLE TAIKHOAN (
    MA_TK CHAR(10),
    TEN_DANGNHAP CHAR(25),
    MATKHAU CHAR(25),
    PRIMARY KEY (MA_TK)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

DROP TABLE IF EXISTS PHONGTHI;
CREATE TABLE PHONGTHI (
    MA_PHONG CHAR(10),
    TEN_PHONG VARCHAR(50),
    SUCCHUA INT,
    DIADIEM VARCHAR(100),
    PRIMARY KEY (MA_PHONG)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

DROP TABLE IF EXISTS DONVICHAMTHI;
CREATE TABLE DONVICHAMTHI (
    MA_DONVI CHAR(10),
    TEN_DONVI VARCHAR(50),
    PRIMARY KEY (MA_DONVI)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc TAIKHOAN =====
DROP TABLE IF EXISTS NHANVIEN;
CREATE TABLE NHANVIEN (
    MA_NV CHAR(10),
    HOTEN VARCHAR(50),
    NGAYSINH DATE,
    GIOITINH VARCHAR(3),
    SDT CHAR(10),
    EMAIL CHAR(50),
    DIACHI VARCHAR(100),
    LOAI_NV VARCHAR(25),
    TINHTRANG_COITHI VARCHAR(25),
    MA_TK CHAR(10),
    PRIMARY KEY (MA_NV),
    FOREIGN KEY (MA_TK) REFERENCES TAIKHOAN(MA_TK)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

DROP TABLE IF EXISTS KHACHHANG;
CREATE TABLE KHACHHANG (
    MA_KH CHAR(10),
    TEN_KH VARCHAR(50),
    EMAIL CHAR(50),
    SDT CHAR(10),
    LOAI_KH VARCHAR(25),
    MA_TK CHAR(10),
    PRIMARY KEY (MA_KH),
    FOREIGN KEY (MA_TK) REFERENCES TAIKHOAN(MA_TK)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc PHONGTHI =====
DROP TABLE IF EXISTS LICHTHI;
CREATE TABLE LICHTHI (
    MA_LICHTHI CHAR(10),
    NGAYTHI DATE,
    GIOTHI TIME,
    LOAI_DANHGIA VARCHAR(10),
    SOLUONG_DANGKY INT,
    MA_PHONG CHAR(10),
    PRIMARY KEY (MA_LICHTHI),
    FOREIGN KEY (MA_PHONG) REFERENCES PHONGTHI(MA_PHONG)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc NHANVIEN, KHACHHANG, LICHTHI =====
DROP TABLE IF EXISTS PHIEUDANGKY;
CREATE TABLE PHIEUDANGKY (
    MA_PHIEUDANGKY CHAR(10),
    NGAYLAP DATE,
    TRANGTHAI_THANHTOAN VARCHAR(25),
    NV_LAP CHAR(10),
    MA_LICHTHI CHAR(10),
    MA_KH CHAR(10),
    PRIMARY KEY (MA_PHIEUDANGKY),
    FOREIGN KEY (NV_LAP) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_KH) REFERENCES KHACHHANG(MA_KH),
    FOREIGN KEY (MA_LICHTHI) REFERENCES LICHTHI(MA_LICHTHI)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc NHANVIEN, KHACHHANG =====
DROP TABLE IF EXISTS PHIEUTHANHTOAN;
CREATE TABLE PHIEUTHANHTOAN (
    MA_PHIEUTHANHTOAN CHAR(10),
    NGAYLAP DATE,
    TRANGTHAI_THANHTOAN VARCHAR(25),
    TONGTIEN INT,
    NGAYTHANHTOAN DATE,
    GIAMGIA FLOAT,
    NV_LAP CHAR(10),
    MA_PHIEUDANGKY CHAR(10),
    MA_KH CHAR(10),
    PRIMARY KEY (MA_PHIEUTHANHTOAN),
    FOREIGN KEY (NV_LAP) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_KH) REFERENCES KHACHHANG(MA_KH)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc NHANVIEN, KHACHHANG, PHIEUTHANHTOAN =====
DROP TABLE IF EXISTS HOADON;
CREATE TABLE HOADON (
    MA_HD CHAR(10),
    NGAYLAP DATE,
    TONGTIEN INT,
    PHUONGTHUC_THANHTOAN VARCHAR(25),
    NV_LAP CHAR(10),
    MA_PHIEUTHANHTOAN CHAR(10),
    MA_KH CHAR(10),
    PRIMARY KEY (MA_HD),
    FOREIGN KEY (NV_LAP) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_PHIEUTHANHTOAN) REFERENCES PHIEUTHANHTOAN(MA_PHIEUTHANHTOAN),
    FOREIGN KEY (MA_KH) REFERENCES KHACHHANG(MA_KH)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc LICHTHI, NHANVIEN =====
DROP TABLE IF EXISTS PHANCONGCOITHI;
CREATE TABLE PHANCONGCOITHI (
    MA_LICHTHI CHAR(10),
    MA_NV CHAR(10),
    PRIMARY KEY (MA_LICHTHI, MA_NV),
    FOREIGN KEY (MA_LICHTHI) REFERENCES LICHTHI(MA_LICHTHI),
    FOREIGN KEY (MA_NV) REFERENCES NHANVIEN(MA_NV)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc PHIEUDANGKY, KHACHHANG =====
DROP TABLE IF EXISTS THISINH;
CREATE TABLE THISINH (
    MA_TS CHAR(10),
    HOTEN VARCHAR(50),
    NGAYSINH DATE,
    GIOITINH VARCHAR(3),
    EMAIL CHAR(50),
    SDT CHAR(10),
    CCCD CHAR(12),
    DIACHI VARCHAR(100),
    MA_KH CHAR(10),
    MA_PHIEUDANGKY CHAR(10),
    PRIMARY KEY (MA_TS),
    FOREIGN KEY (MA_KH) REFERENCES KHACHHANG(MA_KH),
    FOREIGN KEY (MA_PHIEUDANGKY) REFERENCES PHIEUDANGKY(MA_PHIEUDANGKY)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc THISINH, LICHTHI, NHANVIEN, PHIEUDANGKY =====
DROP TABLE IF EXISTS PHIEUDUTHI;
CREATE TABLE PHIEUDUTHI (
    MA_PHIEUDUTHI CHAR(10),
    LAN_GIAHAN INT,
    MA_PHIEUDANGKY CHAR(10),
    NV_LAP CHAR(10),
    MA_LICHTHI CHAR(10),
    MA_TS CHAR(10),
    PRIMARY KEY (MA_PHIEUDUTHI),
    FOREIGN KEY (MA_PHIEUDANGKY) REFERENCES PHIEUDANGKY(MA_PHIEUDANGKY),
    FOREIGN KEY (NV_LAP) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_LICHTHI) REFERENCES LICHTHI(MA_LICHTHI),
    FOREIGN KEY (MA_TS) REFERENCES THISINH(MA_TS)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc PHIEUDUTHI, LICHTHI, DONVICHAMTHI =====
DROP TABLE IF EXISTS BAITHI;
CREATE TABLE BAITHI (
    MA_BAITHI CHAR(10),
    TEN_BAITHI VARCHAR(50),
    HINHTHUCTHI VARCHAR(25),
    THOIGIANTHI INT,
    MA_PHIEUDUTHI CHAR(10),
    MA_LICHTHI CHAR(10),
    DONVICHAM CHAR(10),
    PRIMARY KEY (MA_BAITHI),
    FOREIGN KEY (MA_PHIEUDUTHI) REFERENCES PHIEUDUTHI(MA_PHIEUDUTHI),
    FOREIGN KEY (MA_LICHTHI) REFERENCES LICHTHI(MA_LICHTHI),
    FOREIGN KEY (DONVICHAM) REFERENCES DONVICHAMTHI(MA_DONVI)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc PHIEUDUTHI, NHANVIEN, KHACHHANG =====
DROP TABLE IF EXISTS PHIEUGIAHAN;
CREATE TABLE PHIEUGIAHAN (
    MA_PHIEUGIAHAN CHAR(10),
    LYDO_GIAHAN VARCHAR(100),
    NGAYLAP DATE,
    TINHTRANG_THANHTOAN VARCHAR(25),
    PHIGIAHAN INT,
    NV_LAP CHAR(10),
    MA_PHIEUDUTHI CHAR(10),
    PRIMARY KEY (MA_PHIEUGIAHAN),
    FOREIGN KEY (NV_LAP) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_PHIEUDUTHI) REFERENCES PHIEUDUTHI(MA_PHIEUDUTHI)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc PHIEUDANGKY, KHACHHANG, NHANVIEN =====
DROP TABLE IF EXISTS CHUNGCHI;
CREATE TABLE CHUNGCHI (
    MA_CHUNGCHI CHAR(10),
    TENCHUNGCHI VARCHAR(50),
    KETQUA VARCHAR(3),
    DIEMSO INT,
    NGAYCAP DATE,
    NGAYHETHAN DATE,
    TRANGTHAINHAN VARCHAR(10),
    NV_GHINHAN CHAR(10),
    MA_PHIEUDUTHI CHAR(10),
    MA_KH CHAR(10),
    PRIMARY KEY (MA_CHUNGCHI),
    FOREIGN KEY (NV_GHINHAN) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_PHIEUDUTHI) REFERENCES PHIEUDANGKY(MA_PHIEUDANGKY),
    FOREIGN KEY (MA_KH) REFERENCES KHACHHANG(MA_KH)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- ==insert
INSERT INTO TAIKHOAN (MA_TK, TEN_DANGNHAP, MATKHAU) VALUES
('TK001', 'user1', 'pass1'),
('TK002', 'user2', 'pass2'),
('TK003', 'user3', 'pass3');

-- Insert vào PHONGTHI
INSERT INTO PHONGTHI (MA_PHONG, TEN_PHONG, SUCCHUA, DIADIEM) VALUES
('P001', 'Phòng A1', 50, 'Tầng 1 - Cơ sở chính'),
('P002', 'Phòng B2', 40, 'Tầng 2 - Cơ sở phụ');

-- Insert vào DONVICHAMTHI
INSERT INTO DONVICHAMTHI (MA_DONVI, TEN_DONVI) VALUES
('DV001', 'Đơn vị chấm thi A'),
('DV002', 'Đơn vị chấm thi B');

-- Insert vào NHANVIEN
INSERT INTO NHANVIEN (MA_NV, HOTEN, NGAYSINH, GIOITINH, SDT, EMAIL, DIACHI, LOAI_NV, TINHTRANG_COITHI, MA_TK) VALUES
('NV001', 'Nguyễn Văn A', '1990-01-01', 'Nam', '0909123456', 'a@gmail.com', 'Quận 1, TP.HCM', 'Admin', 'Đang làm', 'TK001');

-- Insert vào KHACHHANG
INSERT INTO KHACHHANG (MA_KH, TEN_KH, EMAIL, SDT, LOAI_KH, MA_TK) VALUES
('KH001', 'Trần Thị B', 'b@gmail.com', '0911222333', 'Cá nhân', 'TK002');
INSERT INTO KHACHHANG (MA_KH, TEN_KH, EMAIL, SDT, LOAI_KH, MA_TK) VALUES
('KH002', 'Trần Thị C', 'b@gmail.com', '0911222333', 'Cá nhân', 'TK001');
-- Insert vào LICHTHI
INSERT INTO LICHTHI (MA_LICHTHI, NGAYTHI, GIOTHI, LOAI_DANHGIA, SOLUONG_DANGKY, MA_PHONG) VALUES
('LT001', '2025-06-15', '08:00:00', 'A', 30, 'P001');
INSERT INTO LICHTHI (MA_LICHTHI, NGAYTHI, GIOTHI, LOAI_DANHGIA, SOLUONG_DANGKY, MA_PHONG) VALUES
('LT002', '2025-06-15', '08:00:00', 'A', 30, 'P001');
INSERT INTO LICHTHI (MA_LICHTHI, NGAYTHI, GIOTHI, LOAI_DANHGIA, SOLUONG_DANGKY, MA_PHONG) VALUES
('LT003', '2025-07-15', '08:00:00', 'A', 30, 'P001');
INSERT INTO LICHTHI (MA_LICHTHI, NGAYTHI, GIOTHI, LOAI_DANHGIA, SOLUONG_DANGKY, MA_PHONG) VALUES
('LT004', '2025-01-15', '08:00:00', 'A', 30, 'P001');
-- Insert vào PHIEUDANGKY
INSERT INTO PHIEUDANGKY (MA_PHIEUDANGKY, NGAYLAP, TRANGTHAI_THANHTOAN, NV_LAP, MA_LICHTHI, MA_KH) VALUES
('PDK001', '2025-05-01', 'Đã thanh toán', 'NV001', 'LT001', 'KH001');
INSERT INTO PHIEUDANGKY (MA_PHIEUDANGKY, NGAYLAP, TRANGTHAI_THANHTOAN, NV_LAP, MA_LICHTHI, MA_KH) VALUES
('PDK002', '2025-06-01', 'Đã thanh toán', 'NV001', 'LT001', 'KH002');
INSERT INTO PHIEUDANGKY (MA_PHIEUDANGKY, NGAYLAP, TRANGTHAI_THANHTOAN, NV_LAP, MA_LICHTHI, MA_KH) VALUES
('PDK003', '2025-06-01', 'Đã thanh toán', 'NV001', 'LT004', 'KH002');
-- Insert vào PHIEUTHANHTOAN
INSERT INTO PHIEUTHANHTOAN (MA_PHIEUTHANHTOAN, NGAYLAP, TRANGTHAI_THANHTOAN, TONGTIEN, NGAYTHANHTOAN, GIAMGIA, NV_LAP, MA_PHIEUDANGKY, MA_KH) VALUES
('PTT001', '2025-05-02', 'Đã thanh toán', 1000000, '2025-05-02', 0, 'NV001', 'PDK001', 'KH001');

-- Insert vào HOADON
INSERT INTO HOADON (MA_HD, NGAYLAP, TONGTIEN, PHUONGTHUC_THANHTOAN, NV_LAP, MA_PHIEUTHANHTOAN, MA_KH) VALUES
('HD001', '2025-05-02', 1000000, 'Chuyển khoản', 'NV001', 'PTT001', 'KH001');

-- Insert vào PHANCONGCOITHI
INSERT INTO PHANCONGCOITHI (MA_LICHTHI, MA_NV) VALUES
('LT001', 'NV001');

-- Insert vào THISINH
INSERT INTO THISINH (MA_TS, HOTEN, NGAYSINH, GIOITINH, EMAIL, SDT, CCCD, DIACHI, MA_KH, MA_PHIEUDANGKY) VALUES
('TS001', 'Lê Văn C', '2000-08-20', 'Nam', 'c@gmail.com', '0988777666', '123456789012', 'Quận 3, TP.HCM', 'KH001', 'PDK001');
INSERT INTO THISINH (MA_TS, HOTEN, NGAYSINH, GIOITINH, EMAIL, SDT, CCCD, DIACHI, MA_KH, MA_PHIEUDANGKY) VALUES
('TS002', 'Lê Văn D', '2000-08-20', 'Nam', 'c@gmail.com', '0988777666', '123456789012', 'Quận 3, TP.HCM', 'KH001', 'PDK001');

-- Insert vào PHIEUDUTHI
INSERT INTO PHIEUDUTHI (MA_PHIEUDUTHI, LAN_GIAHAN, MA_PHIEUDANGKY, NV_LAP, MA_LICHTHI, MA_TS) VALUES
('PDT001', 0, 'PDK001', 'NV001', 'LT001', 'TS001');
INSERT INTO PHIEUDUTHI (MA_PHIEUDUTHI, LAN_GIAHAN, MA_PHIEUDANGKY, NV_LAP, MA_LICHTHI, MA_TS)
VALUES ('PDT002', 0, 'PDK001', 'NV001', 'LT003', 'TS002');
INSERT INTO PHIEUDUTHI (MA_PHIEUDUTHI, LAN_GIAHAN, MA_PHIEUDANGKY, NV_LAP, MA_LICHTHI, MA_TS)
VALUES ('PDT003', 0, 'PDK003', 'NV001', 'LT004', 'TS002');
-- Insert vào BAITHI
INSERT INTO BAITHI (MA_BAITHI, TEN_BAITHI, HINHTHUCTHI, THOIGIANTHI, MA_PHIEUDUTHI, MA_LICHTHI, DONVICHAM) VALUES
('BT001', 'Bài thi chứng chỉ A', 'Trắc nghiệm', 60, 'PDT001', 'LT001', 'DV001');

-- Insert vào PHIEUGIAHAN
INSERT INTO PHIEUGIAHAN (MA_PHIEUGIAHAN, LYDO_GIAHAN, NGAYLAP, TINHTRANG_THANHTOAN, PHIGIAHAN, NV_LAP, MA_PHIEUDUTHI) VALUES
('PGH001', 'Bận công tác', '2025-06-01', 'Đã thanh toán', 50000, 'NV001', 'PDT001');

-- Insert vào CHUNGCHI
INSERT INTO CHUNGCHI (MA_CHUNGCHI, TENCHUNGCHI, KETQUA, DIEMSO, NGAYCAP, NGAYHETHAN, TRANGTHAINHAN, NV_GHINHAN, MA_PHIEUDUTHI, MA_KH) VALUES
('CC001', 'Chứng chỉ Tin học A', 'Đạt', 85, '2025-07-01', '2030-07-01', 'Đã nhận', 'NV001', 'PDK001', 'KH001');
-- ===== Kiểm tra =====
SELECT * FROM KHACHHANG;
SELECT * FROM BAITHI;
select * from taikhoan;

SELECT p.MA_PHIEUDUTHI, p.LAN_GIAHAN, l.NGAYTHI
      FROM PHIEUDUTHI p
      JOIN LICHTHI l ON p.MA_LICHTHI = l.MA_LICHTHI;
      
      



-- CHẠY TRONG MYSQL WORKBENCH
-- Tạo cơ sở dữ liệu QLCHUNGCHI với các bảng và dữ liệu phù hợp với script JavaScript
-- Đảm bảo khóa ngoại chính xác, dữ liệu thống nhất, hỗ trợ các truy vấn JOIN

DROP DATABASE IF EXISTS QLCHUNGCHI;
CREATE DATABASE QLCHUNGCHI;
USE QLCHUNGCHI;

-- ===== Bảng không phụ thuộc =====
CREATE TABLE TAIKHOAN (
    MA_TK CHAR(10),
    TEN_DANGNHAP CHAR(25),
    MATKHAU CHAR(25),
    PRIMARY KEY (MA_TK)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE PHONGTHI (
    MA_PHONG CHAR(10),
    TEN_PHONG VARCHAR(50),
    SUCCHUA INT,
    DIADIEM VARCHAR(100),
    PRIMARY KEY (MA_PHONG)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE DONVICHAMTHI (
    MA_DONVI CHAR(10),
    TEN_DONVI VARCHAR(50),
    PRIMARY KEY (MA_DONVI)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc TAIKHOAN =====
CREATE TABLE NHANVIEN (
    MA_NV CHAR(10),
    HOTEN VARCHAR(50),
    NGAYSINH DATE,
    GIOITINH VARCHAR(3),
    SDT CHAR(10),
    EMAIL CHAR(50),
    DIACHI VARCHAR(100),
    LOAI_NV VARCHAR(25),
    TINHTRANG_COITHI VARCHAR(25),
    MA_TK CHAR(10),
    PRIMARY KEY (MA_NV),
    FOREIGN KEY (MA_TK) REFERENCES TAIKHOAN(MA_TK)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE KHACHHANG (
    MA_KH CHAR(10),
    TEN_KH VARCHAR(50),
    EMAIL CHAR(50),
    SDT CHAR(10),
    LOAI_KH VARCHAR(25),
    MA_TK CHAR(10),
    PRIMARY KEY (MA_KH),
    FOREIGN KEY (MA_TK) REFERENCES TAIKHOAN(MA_TK)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc PHONGTHI =====
CREATE TABLE LICHTHI (
    MA_LICHTHI CHAR(10),
    NGAYTHI DATE,
    GIOTHI TIME,
    LOAI_DANHGIA VARCHAR(10),
    SOLUONG_DANGKY INT,
    MA_PHONG CHAR(10),
    PRIMARY KEY (MA_LICHTHI),
    FOREIGN KEY (MA_PHONG) REFERENCES PHONGTHI(MA_PHONG)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc NHANVIEN, KHACHHANG, LICHTHI =====
CREATE TABLE PHIEUDANGKY (
    MA_PHIEUDANGKY CHAR(10),
    NGAYLAP DATE,
    TRANGTHAI_THANHTOAN VARCHAR(25),
    NV_LAP CHAR(10),
    MA_LICHTHI CHAR(10),
    MA_KH CHAR(10),
    PRIMARY KEY (MA_PHIEUDANGKY),
    FOREIGN KEY (NV_LAP) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_KH) REFERENCES KHACHHANG(MA_KH),
    FOREIGN KEY (MA_LICHTHI) REFERENCES LICHTHI(MA_LICHTHI)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc NHANVIEN, KHACHHANG =====
CREATE TABLE PHIEUTHANHTOAN (
    MA_PHIEUTHANHTOAN CHAR(10),
    NGAYLAP DATE,
    TRANGTHAI_THANHTOAN VARCHAR(25),
    TONGTIEN INT,
    NGAYTHANHTOAN DATE,
    GIAMGIA FLOAT,
    NV_LAP CHAR(10),
    MA_PHIEUDANGKY CHAR(10),
    MA_KH CHAR(10),
    PRIMARY KEY (MA_PHIEUTHANHTOAN),
    FOREIGN KEY (NV_LAP) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_KH) REFERENCES KHACHHANG(MA_KH),
    FOREIGN KEY (MA_PHIEUDANGKY) REFERENCES PHIEUDANGKY(MA_PHIEUDANGKY)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc NHANVIEN, KHACHHANG, PHIEUTHANHTOAN =====
CREATE TABLE HOADON (
    MA_HD CHAR(10),
    NGAYLAP DATE,
    TONGTIEN INT,
    PHUONGTHUC_THANHTOAN VARCHAR(25),
    NV_LAP CHAR(10),
    MA_PHIEUTHANHTOAN CHAR(10),
    MA_KH CHAR(10),
    PRIMARY KEY (MA_HD),
    FOREIGN KEY (NV_LAP) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_PHIEUTHANHTOAN) REFERENCES PHIEUTHANHTOAN(MA_PHIEUTHANHTOAN),
    FOREIGN KEY (MA_KH) REFERENCES KHACHHANG(MA_KH)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc LICHTHI, NHANVIEN =====
CREATE TABLE PHANCONGCOITHI (
    MA_LICHTHI CHAR(10),
    MA_NV CHAR(10),
    PRIMARY KEY (MA_LICHTHI, MA_NV),
    FOREIGN KEY (MA_LICHTHI) REFERENCES LICHTHI(MA_LICHTHI),
    FOREIGN KEY (MA_NV) REFERENCES NHANVIEN(MA_NV)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc PHIEUDANGKY, KHACHHANG =====
CREATE TABLE THISINH (
    MA_TS CHAR(10),
    HOTEN VARCHAR(50),
    NGAYSINH DATE,
    GIOITINH VARCHAR(3),
    EMAIL CHAR(50),
    SDT CHAR(10),
    CCCD CHAR(12),
    DIACHI VARCHAR(100),
    MA_KH CHAR(10),
    MA_PHIEUDANGKY CHAR(10),
    PRIMARY KEY (MA_TS),
    FOREIGN KEY (MA_KH) REFERENCES KHACHHANG(MA_KH),
    FOREIGN KEY (MA_PHIEUDANGKY) REFERENCES PHIEUDANGKY(MA_PHIEUDANGKY)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc THISINH, LICHTHI, NHANVIEN, PHIEUDANGKY =====
CREATE TABLE PHIEUDUTHI (
    MA_PHIEUDUTHI CHAR(10),
    LAN_GIAHAN INT,
    MA_PHIEUDANGKY CHAR(10),
    NV_LAP CHAR(10),
    MA_LICHTHI CHAR(10),
    MA_TS CHAR(10),
    PRIMARY KEY (MA_PHIEUDUTHI),
    FOREIGN KEY (MA_PHIEUDANGKY) REFERENCES PHIEUDANGKY(MA_PHIEUDANGKY),
    FOREIGN KEY (NV_LAP) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_LICHTHI) REFERENCES LICHTHI(MA_LICHTHI),
    FOREIGN KEY (MA_TS) REFERENCES THISINH(MA_TS)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc PHIEUDUTHI, LICHTHI, DONVICHAMTHI =====
CREATE TABLE BAITHI (
    MA_BAITHI CHAR(10),
    TEN_BAITHI VARCHAR(50),
    HINHTHUCTHI VARCHAR(25),
    THOIGIANTHI INT,
    MA_PHIEUDUTHI CHAR(10),
    MA_LICHTHI CHAR(10),
    DONVICHAM CHAR(10),
    PRIMARY KEY (MA_BAITHI),
    FOREIGN KEY (MA_PHIEUDUTHI) REFERENCES PHIEUDUTHI(MA_PHIEUDUTHI),
    FOREIGN KEY (MA_LICHTHI) REFERENCES LICHTHI(MA_LICHTHI),
    FOREIGN KEY (DONVICHAM) REFERENCES DONVICHAMTHI(MA_DONVI)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc PHIEUDUTHI, NHANVIEN =====
CREATE TABLE PHIEUGIAHAN (
    MA_PHIEUGIAHAN CHAR(10),
    LYDO_GIAHAN VARCHAR(100),
    NGAYLAP DATE,
    TINHTRANG_THANHTOAN VARCHAR(25),
    PHIGIAHAN INT,
    NV_LAP CHAR(10),
    MA_PHIEUDUTHI CHAR(10),
    PRIMARY KEY (MA_PHIEUGIAHAN),
    FOREIGN KEY (NV_LAP) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_PHIEUDUTHI) REFERENCES PHIEUDUTHI(MA_PHIEUDUTHI)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Bảng phụ thuộc PHIEUDUTHI, KHACHHANG, NHANVIEN =====
CREATE TABLE CHUNGCHI (
    MA_CHUNGCHI CHAR(10),
    TENCHUNGCHI VARCHAR(50),
    KETQUA VARCHAR(20),
    DIEMSO INT,
    NGAYCAP DATE,
    NGAYHETHAN DATE,
    TRANGTHAINHAN VARCHAR(10),
    NV_GHINHAN CHAR(10),
    MA_PHIEUDUTHI CHAR(10),
    MA_KH CHAR(10),
    PRIMARY KEY (MA_CHUNGCHI),
    FOREIGN KEY (NV_GHINHAN) REFERENCES NHANVIEN(MA_NV),
    FOREIGN KEY (MA_PHIEUDUTHI) REFERENCES PHIEUDUTHI(MA_PHIEUDUTHI),
    FOREIGN KEY (MA_KH) REFERENCES KHACHHANG(MA_KH)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ===== Insert dữ liệu =====
-- Insert vào TAIKHOAN (Tài khoản admin với tên đăng nhập admin1, admin2...)
INSERT INTO TAIKHOAN (MA_TK, TEN_DANGNHAP, MATKHAU) VALUES
('TK001', 'admin1', 'adminpass1'),
('TK002', 'admin2', 'adminpass2'),
('TK003', 'admin3', 'adminpass3'),
('TK004', 'kh1', 'khpass1'),
('TK005', 'kh2', 'khpass2'),
('TK006', 'kh3', 'khpass3');

-- Insert vào PHONGTHI
INSERT INTO PHONGTHI (MA_PHONG, TEN_PHONG, SUCCHUA, DIADIEM) VALUES
('P001', 'Phòng A1', 50, 'Tầng 1 - Cơ sở chính, TP.HCM'),
('P002', 'Phòng B2', 40, 'Tầng 2 - Cơ sở phụ, TP.HCM'),
('P003', 'Phòng C3', 60, 'Tầng 3 - Cơ sở chính, TP.HCM');

-- Insert vào DONVICHAMTHI
INSERT INTO DONVICHAMTHI (MA_DONVI, TEN_DONVI) VALUES
('DV001', 'Đơn vị chấm thi A'),
('DV002', 'Đơn vị chấm thi B'),
('DV003', 'Đơn vị chấm thi C');

-- Insert vào NHANVIEN (Nhân viên sử dụng tài khoản admin)
INSERT INTO NHANVIEN (MA_NV, HOTEN, NGAYSINH, GIOITINH, SDT, EMAIL, DIACHI, LOAI_NV, TINHTRANG_COITHI, MA_TK) VALUES
('NV001', 'Nguyễn Văn Hùng', '1988-03-15', 'Nam', '0909123456', 'hungnv@gmail.com', '123 Lê Lợi, Quận 1, TP.HCM', 'Admin', 'Đang làm', 'TK001'),
('NV002', 'Trần Thị Mai', '1992-07-22', 'Nữ', '0918234567', 'maitt@gmail.com', '456 Nguyễn Huệ, Quận 3, TP.HCM', 'Admin', 'Đang làm', 'TK002'),
('NV003', 'Phạm Quốc Anh', '1990-11-10', 'Nam', '0937345678', 'anhpq@gmail.com', '789 Võ Văn Tần, Quận 7, TP.HCM', 'Admin', 'Đang làm', 'TK003');

-- Insert vào KHACHHANG (Tên tiếng Việt đầy đủ, email dựa trên tên)
INSERT INTO KHACHHANG (MA_KH, TEN_KH, EMAIL, SDT, LOAI_KH, MA_TK) VALUES
('KH001', 'Lê Thị Hồng Nhung', 'nhunglth@gmail.com', '0988111222', 'Cá nhân', 'TK004'),
('KH002', 'Nguyễn Minh Tuấn', 'tuannm@gmail.com', '0977222333', 'Cá nhân', 'TK005'),
('KH003', 'Trần Văn Khánh', 'khanhtv@gmail.com', '0966333444', 'Đơn vị', 'TK006');

-- Insert vào LICHTHI
INSERT INTO LICHTHI (MA_LICHTHI, NGAYTHI, GIOTHI, LOAI_DANHGIA, SOLUONG_DANGKY, MA_PHONG) VALUES
('LT001', '2025-06-15', '08:00:00', 'A', 30, 'P001'),
('LT002', '2025-06-20', '13:00:00', 'B', 25, 'P002'),
('LT003', '2025-07-10', '09:00:00', 'A', 40, 'P003');

-- Insert vào PHIEUDANGKY
INSERT INTO PHIEUDANGKY (MA_PHIEUDANGKY, NGAYLAP, TRANGTHAI_THANHTOAN, NV_LAP, MA_LICHTHI, MA_KH) VALUES
('PDK001', '2025-04-01', 'Đã thanh toán', 'NV001', 'LT001', 'KH001'),
('PDK002', '2025-04-01', 'Đã thanh toán', 'NV002', 'LT002', 'KH002'),
('PDK003', '2025-04-01', 'Đã thanh toán', 'NV003', 'LT003', 'KH003');

-- Insert vào PHIEUTHANHTOAN
INSERT INTO PHIEUTHANHTOAN (MA_PHIEUTHANHTOAN, NGAYLAP, TRANGTHAI_THANHTOAN, TONGTIEN, NGAYTHANHTOAN, GIAMGIA, NV_LAP, MA_PHIEUDANGKY, MA_KH) VALUES
('PTT001', '2025-05-02', 'Đã thanh toán', 1000000, '2025-05-02', 0, 'NV001', 'PDK001', 'KH001'),
('PTT002', '2025-05-06', 'Đã thanh toán', 800000, '2025-05-06', 0.1, 'NV002', 'PDK002', 'KH002'),
('PTT003', '2025-05-02', 'Đã thanh toán', 1200000, NULL, 0, 'NV003', 'PDK003', 'KH003');

-- Insert vào HOADON
INSERT INTO HOADON (MA_HD, NGAYLAP, TONGTIEN, PHUONGTHUC_THANHTOAN, NV_LAP, MA_PHIEUTHANHTOAN, MA_KH) VALUES
('HD001', '2025-05-02', 1000000, 'Chuyển khoản', 'NV001', 'PTT001', 'KH001'),
('HD002', '2025-05-06', 720000, 'Tiền mặt', 'NV002', 'PTT002', 'KH002'),
('HD003', '2025-06-02', 1200000, 'Chuyển khoản', 'NV003', 'PTT003', 'KH003');

-- Insert vào PHANCONGCOITHI
INSERT INTO PHANCONGCOITHI (MA_LICHTHI, MA_NV) VALUES
('LT001', 'NV001'),
('LT002', 'NV002'),
('LT003', 'NV003');

-- Insert vào THISINH
INSERT INTO THISINH (MA_TS, HOTEN, NGAYSINH, GIOITINH, EMAIL, SDT, CCCD, DIACHI, MA_KH, MA_PHIEUDANGKY) VALUES
('TS001', 'Lê Thị Hồng Nhung', '1998-04-12', 'Nữ', 'nhunglth@gmail.com', '0988111222', '123456789012', '101 Nguyễn Trãi, Quận 5, TP.HCM', 'KH001', 'PDK001'),
('TS002', 'Nguyễn Minh Tuấn', '1995-09-25', 'Nam', 'tuannm@gmail.com', '0977222333', '987654321098', '202 Phạm Văn Đồng, Quận Gò Vấp, TP.HCM', 'KH002', 'PDK002'),
('TS003', 'Trần Văn Khánh', '1997-02-18', 'Nam', 'khanhtv@gmail.com', '0966333444', '456789123456', '303 Lý Thái Tổ, Quận 10, TP.HCM', 'KH003', 'PDK003'),
('TS004', 'Trần Văn Hinh', '1997-02-20', 'Nam', 'khanhtv@gmail.com', '0966333555', '456789123457', '303 Lý Thái Tổ, Quận 10, TP.HCM', 'KH003', 'PDK003');
-- Insert vào PHIEUDUTHI
INSERT INTO PHIEUDUTHI (MA_PHIEUDUTHI, LAN_GIAHAN, MA_PHIEUDANGKY, NV_LAP, MA_LICHTHI, MA_TS) VALUES
('PDT001', 0, 'PDK001', 'NV001', 'LT001', 'TS001'),
('PDT002', 0, 'PDK002', 'NV002', 'LT002', 'TS002'),
('PDT003', 1, 'PDK003', 'NV003', 'LT003', 'TS003'),
('PDT004', 1, 'PDK003', 'NV003', 'LT003', 'TS003');
-- Insert vào BAITHI
INSERT INTO BAITHI (MA_BAITHI, TEN_BAITHI, HINHTHUCTHI, THOIGIANTHI, MA_PHIEUDUTHI, MA_LICHTHI, DONVICHAM) VALUES
('BT001', 'Bài thi chứng chỉ A', 'Trắc nghiệm', 60, 'PDT001', 'LT001', 'DV001'),
('BT002', 'Bài thi chứng chỉ B', 'Tự luận', 90, 'PDT002', 'LT002', 'DV002'),
('BT003', 'Bài thi chứng chỉ A', 'Trắc nghiệm', 60, 'PDT003', 'LT003', 'DV003');

-- Insert vào PHIEUGIAHAN
INSERT INTO PHIEUGIAHAN (MA_PHIEUGIAHAN, LYDO_GIAHAN, NGAYLAP, TINHTRANG_THANHTOAN, PHIGIAHAN, NV_LAP, MA_PHIEUDUTHI) VALUES
('PGH001', 'Bận công tác', '2025-06-01', 'Đã thanh toán', 50000, 'NV001', 'PDT001'),
('PGH002', 'Lý do cá nhân', '2025-06-05', 'Chưa thanh toán', 50000, 'NV002', 'PDT002'),
('PGH003', 'Sức khỏe', '2025-06-10', 'Đã thanh toán', 50000, 'NV003', 'PDT003');

-- Insert vào CHUNGCHI
INSERT INTO CHUNGCHI (MA_CHUNGCHI, TENCHUNGCHI, KETQUA, DIEMSO, NGAYCAP, NGAYHETHAN, TRANGTHAINHAN, NV_GHINHAN, MA_PHIEUDUTHI, MA_KH) VALUES
('CC001', 'Chứng chỉ Tin học A', 'Đạt', 85, '2025-07-01', '2030-07-01', 'Đã nhận', 'NV001', 'PDT001', 'KH001'),
('CC002', 'Chứng chỉ Ngoại ngữ B', 'Đạt', 90, '2025-07-05', '2030-07-05', 'Chưa nhận', 'NV002', 'PDT002', 'KH002'),
('CC003', 'Chứng chỉ Tin học A', 'Không', 65, '2025-07-15', '2030-07-15', 'Chưa nhận', 'NV003', 'PDT003', 'KH003');

-- ===== Kiểm tra dữ liệu =====
SELECT * FROM KHACHHANG;
SELECT * FROM BAITHI;
SELECT * FROM TAIKHOAN;
SELECT p.MA_PHIEUDUTHI, p.LAN_GIAHAN, l.NGAYTHI
FROM PHIEUDUTHI p
JOIN LICHTHI l ON p.MA_LICHTHI = l.MA_LICHTHI;
